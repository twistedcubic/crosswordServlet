<!DOCTYPE html>
<!--crossword server frontend-->
<html>
<head>
<meta charset="UTF-8">
<title>Math Search</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- <link rel="stylesheet" href="assets/css/main.css" /> -->
<link rel="stylesheet" href="css/main.css" />

<script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>

</head>
<body class="landing">

	<!-- Header -->
	<header id="header" class="alt">
		<h1>
			<a href="index.html">Crossword Puzzle</a>
		</h1>
	</header>

	<section id="banner" class="wrapper special">
		<div class="inner">
			<form class="inputForm" id="inputForm">
				<div class="row uniform 50%">
					<div class="12u$">
						<!--<textarea name="text" name="inputString" id="inputString" rows="2"></textarea>-->
						<input type="text" name="inputString" id="inputString"  />
					</div>
				</div>
				<ul class="actions">
					<li><input type="submit" name="submitInputBtn" class="special"
						id="enterString" value="Search" /></li>
					<li><input type="button" name="clearOutputBtn" class="special" id="clearOutput"
						value="Clear" /></li>
				</ul>
			</form>
		</div>
		<hr />
		<div id="container" class="align-left">
			<div class="args"></div>
		</div>
		<hr />
		<hr />
	</section>

	<section id="two" class="wrapper special">
		<div class="inner">
			<header class="major narrow">
				<p>Found a bug? Had an idea?</p>
			</header>
			<form name="commentForm" id="commentForm">
				<div class="row uniform 50%">
					<div class="6u 12u$(xsmall)">
						<input type="text" name="uuid" id="uuid" value=""
							placeholder="Your UUID" />
					</div>
					<div class="12u$">
						<textarea name="message" id="comment"
							placeholder="How can I do better?" rows="3"></textarea>
					</div>
				</div>
				<ul class="actions">
					<li><input type="submit" name="submitCommentBtn"
						class="special" value="Share" /></li>
				</ul>

			</form>		
		</div>
		<div class="formSubmitted"></div>	
	</section>
	
	<div id="test1"></div>

	<script>
	
    $("#test1").append($(
            "<div>",
            {
                id: "test2",
                text: "hi",
                
            }
        ).css("position","absolute")
        .css("left",100)
        .css("top",40)
        );
    
		$("#clearOutput").click(function(event) {
			event.preventDefault();
			$("#container").empty();
		});		
		
		//when "search" button is clicked
		$("#inputForm").submit(function(event) {
			event.preventDefault();

			var inputStr = $("#inputString").val();
			//console.log("document.location.href: " + document.location.href);
			createPuzzle(inputStr);

		})
		
		var SERVER_ERROR = 500;
		var NODE_WIDTH = 30;
		var NODE_HEIGHT = 30;
		
		//figure out the server on which this is run
		var cur_url = document.location.href;
		//has form e.g. http://localhost:8080/crossword/crossword
		var page_url = cur_url.replace("index.html", "") + "crossword";
		//var page_url = cur_url.replace("search.html", "") + "thmpsearch";
		
		$("#container").append(
				$("<div>",
				{
					id: "rowWords",
					text: "Row words:"
				}
				).css("position","absolute")
				//dynamically adjust these!!
			    .css("left", 200)
			    .css("top", 450)
		);
		$("#container").append(
				$("<div>",
				{
					id: "colWords",
					text: "Column words:"
				}
				).css("position","absolute")
				//dynamically adjust these!!
			    .css("left", 400)
			    .css("top", 450)
		);
		
		var createPuzzle = function(wordsStr) {
			if (wordsStr == null || wordsStr.length == 0)
				return;			
			
			//must send request as string!
			//var commaPat = /\s*,\s*/;
			//var wordsAr = wordsStr.split(commaPat);
			console.log("Making GET request, wordsStr: " + wordsStr);
			
			$.ajax({
				url : page_url,
				dataType : "json",
				data : {
					words : wordsStr
				},
				type : "GET",
				cache: false
			}).done(
					function(response) {
						//response is a collection of lists recording coordinates, 
						//and some maps for which labels go with which words.
						
						console.log("Returned from GET request. Response: "+response);
						
						if(response == SERVER_ERROR){
							container.prepend("<div>Oops, something internal went wrong. Working on it!</div>")
							return;
						}
						
						if(response != null){							
							//response will consists of list of strings that 
							//are highest-ranked thms. Make it left-aligned!
							$.each(response, function(index, item) {
							
								console.log("row col " + item["row"] +" " + item["col"]);
								//process each PuzzleNodeCoordinates in list
								if(item["row"] == null || item["col"] == null){
									return true;
								}
								
								
								//draw at row and col coordinates.
								$("#container").append(
										$("<div>",
										{
											class: "square",
											text: item["label"]
										}
										).css("position","absolute")
										//dynamically adjust these!!
									    .css("left", item["col"]*NODE_WIDTH + 200)
									    .css("top", item["row"]*NODE_HEIGHT + 150)
								);
								
								console.log(item["rowWord"] + " item["colWord"] " +item["colWord"]);
								//each coordinate has either rowWord or colWord, or neither, but never both
								
								if(undefined != item["rowWord"]){
									let elemId = "rowWords";
									let word = item["rowWord"];
									appendWord(elemId, word);
								}else if(undefined != item["colWord"]){
									let elemId = "colWords";
									let word = item["colWord"];
									appendWord(elemId, word);
								}
								
							});
							
						}else{
							container.prepend("<div>I've got nothing for you yet. Try again.</div>");
						}
					});

		}//end of createPuzzle() function
		
		//id of element to attach to, and the word to attach
		var appendWord = function(elemId, word){
			$("#"+elemId).append(
					$("<div>",
					{
						//class: "square",
						text: word
					}
					)
					//should just append!
					//.css("position","absolute")
					//dynamically adjust these!!
				    //.css("left", item["col"]*NODE_WIDTH + 200)
				    //.css("top", item["row"]*NODE_HEIGHT + 150)
			);
			
		}
		
		$("#commentForm").submit(function(event) {
			event.preventDefault();

			var comment = $("#comment").val();
			var uuid = $("#uuid").val();
			sendComment(comment, uuid);
			giveThanks();

		})

		var giveThanks = function() {
			var container = $(".formSubmitted");
			//pick something random
			//if($('.formSubmittedParent > div.formSubmitted:contains(".*")').length > 0){
			if ($('.formSubmitted > div').length > 0) {
				container.html("<div>You rock!</div>");
			} else {
				container.html("<div>Thanks!</div>");
			}

		}

		var sendComment = function(comment, uuid) {
			if (comment == null || comment.length == 0)
				return;
			var cur_url = document.location.href;
			var url = cur_url.replace("search.html", "") + "thmp1";
			
			$.ajax({
				url : "http://localhost:8080/theoremSearch/thmp1",
				dataType : "json",
				data : {
					"comment" : comment,
					"uuid" : uuid
				},
				type : "POST",
				success : function() {
					$(".formSubmitted").html("<divd>Thanks!</div>");
				}

			});
		}
	</script>

	<script src="assets/js/skel.min.js"></script>
	<script src="assets/js/util.js"></script>
	<script src="assets/js/main.js"></script>

</body>
</html>